{"version":3,"file":"webgpu-debug-helper.js","sources":["../../../src/webgpu-debug-helper.ts"],"sourcesContent":["if (typeof GPUDevice !== 'undefined') {\n  const deviceToErrorScopeStack: WeakMap<GPUDevice, {filter: GPUErrorFilter, errors: GPUError[]}[]> = new WeakMap();\n  const origPushErrorScope = GPUDevice.prototype.pushErrorScope;\n  const origPopErrorScope = GPUDevice.prototype.popErrorScope;\n\n  function assert(condition: boolean, msg?: string | (() => string)): asserts condition {\n    if (!condition) {\n      emitError(msg ? (typeof msg === 'string' ? msg : msg()) : '');\n    }\n  }\n\n  function getFilterForGPUError(error: GPUError): GPUErrorFilter {\n    if (error instanceof GPUValidationError) {\n      return 'validation';\n    }\n    if (error instanceof GPUOutOfMemoryError) {\n      return 'out-of-memory';\n    }\n    if (error instanceof GPUInternalError) {\n      return 'internal';\n    }\n    throw new Error('unknown GPUError type');\n  }\n\n  function emitGPUError(device: GPUDevice, error: GPUError) {\n    const filter = getFilterForGPUError(error);\n    const errorScopeStack = deviceToErrorScopeStack.get(device)!;\n    const currentErrorScope = errorScopeStack.findLast(scope => scope.filter === filter);\n    if (currentErrorScope) {\n      currentErrorScope.errors.push(error);\n    } else {\n      device.dispatchEvent(new GPUUncapturedErrorEvent('uncapturedError', { error }));\n    }\n  }\n\n  interface ThingWithPrototype<T> extends Object {\n    prototype: Record<string, any>;\n  };\n\n  function addErrorWrapper<T>(api: ThingWithPrototype<T>, fnName: string) {\n    const origFn = api.prototype[fnName];\n    api.prototype[fnName] = function(this: T, ...args: any[]) {\n      const stack = new Error();\n      origPushErrorScope.call(this, 'validation');\n      const result = origFn.call(this, ...args);\n      origPopErrorScope.call(this)\n        .then(error => {\n          if (error) {\n            console.error(fnName, args);\n            console.error(error.message);\n            console.error(stack.stack);\n            emitGPUError(this as GPUDevice, error);\n          }\n         });\n      return result;\n    }\n  }\n\n  function getAPIFunctionNames<T>(api: ThingWithPrototype<T>) {\n    return Object.entries(Object.getOwnPropertyDescriptors(api.prototype))\n       .filter(([, info]) => info.enumerable && typeof info.value === 'function')\n       .map(([name]) => name)\n  }\n\n  const skip = new Set([\n    'pushErrorScope',\n    'popErrorScope',\n    'destroy',\n  ]);\n  getAPIFunctionNames(GPUDevice)\n    .filter(n => !skip.has(n))\n    .forEach(n => addErrorWrapper(GPUDevice, n));\n\n  GPUDevice.prototype.pushErrorScope = (function(origFn) {\n    return function(this: GPUDevice, filter: GPUErrorFilter) {\n      origFn.call(this, filter);\n      const errorScopeStack = deviceToErrorScopeStack.get(this);\n      errorScopeStack!.push({filter, errors: []});\n    };\n  })(GPUDevice.prototype.pushErrorScope)\n\n  GPUDevice.prototype.popErrorScope = (function(origFn) {\n    return async function(this: GPUDevice) {\n      const errorScopeStack = deviceToErrorScopeStack.get(this);\n      const errorScope = errorScopeStack!.pop();\n      if (errorScope === undefined) {\n        throw new DOMException('popErrorScope called on empty error scope stack', 'OperationError');\n      }\n      const err = await origFn.call(this);\n      return errorScope.errors.length > 0 ? errorScope.errors.pop()! : err;\n    };\n  })(GPUDevice.prototype.popErrorScope)\n\n  GPUAdapter.prototype.requestDevice = (function(origFn) {\n    return async function(this: GPUAdapter, ...args) {\n      const device = await origFn.call(this, ...args);\n      if (device) {\n        device.addEventListener('uncapturederror', function(e) {\n          console.error((e as GPUUncapturedErrorEvent).error.message);\n        });\n        deviceToErrorScopeStack.set(device, []);\n      }\n      return device;\n    }\n  })(GPUAdapter.prototype.requestDevice);\n\n  function wrapFunctionBefore<K extends PropertyKey, T extends Record<K, (...args: any) => any>>(\n      API: { prototype: T },\n      fnName: K, fn: (...args: Parameters<T[K]>) => void) {\n    const origFn = API.prototype[fnName];\n    API.prototype[fnName] = function (this: T, ...args: any) {\n      fn.call(this, ...args);\n      return origFn.call(this, ...args);\n    } as any;\n  }\n\n  function wrapFunctionAfter<K extends PropertyKey, T extends Record<K, (...args: any) => any>>(\n      API: { prototype: T },\n      fnName: K, fn: (obj: ReturnType<T[K]>,...args: Parameters<T[K]>) => void) {\n    const origFn = API.prototype[fnName];\n    API.prototype[fnName] = function (this: T, ...args: any) {\n      const result = origFn.call(this, ...args);\n      fn.call(this, result, ...args);\n      return result;\n    } as any;\n  }\n\n  type LabeledObject = GPUTexture | GPUTextureView | GPURenderPassEncoder | GPUCommandEncoder;\n\n  function emitError(msg: string, objs: LabeledObject[] = []) {\n    throw new Error(`${msg}\\n${(objs).map(o => `[${o.constructor.name}]${o.label}`).join('\\n')}`);\n  }\n\n  type RenderPassInfo = {\n    targetWidth: number,\n    targetHeight: number,\n  };\n\n  const textureViewToTexture = new WeakMap<GPUTextureView, GPUTexture>();\n  const renderPassToPassInfoMap = new WeakMap<GPURenderPassEncoder, RenderPassInfo>();\n\n  wrapFunctionAfter(GPUTexture, 'createView', function(this: GPUTexture, view: GPUTextureView, desc?: GPUTextureViewDescriptor) {\n    textureViewToTexture.set(view, this);\n  });\n\n  wrapFunctionAfter(GPUCommandEncoder, 'beginRenderPass', function(this: GPUCommandEncoder, passEncoder: GPURenderPassEncoder, desc: GPURenderPassDescriptor) {\n    let targetWidth: number | undefined;\n    let targetHeight: number | undefined;\n\n    const addView = (attachment: GPURenderPassColorAttachment | GPURenderPassDepthStencilAttachment | null | undefined) => {\n      if (!attachment) {\n        return;\n      }\n      const {view} = attachment;\n      const texture = textureViewToTexture.get(view)!;\n      const {width, height} = texture;\n      if (targetWidth === undefined) {\n        targetWidth = width;\n        targetHeight = height;\n      } else if (targetWidth !== width || targetHeight !== height) {\n        emitError('attachments are not all the same width and height', [view, texture, passEncoder, this]);\n      }\n    }\n\n    for (const colorAttachment of desc.colorAttachments || []) {\n        addView(colorAttachment);\n    }\n\n    addView(desc.depthStencilAttachment);\n\n    assert(targetWidth !== undefined);\n    assert(targetHeight !== undefined);\n\n    renderPassToPassInfoMap.set(passEncoder, {\n      targetWidth,\n      targetHeight,\n    });\n  });\n\n  wrapFunctionBefore(GPURenderPassEncoder, 'setViewport', function(this: GPURenderPassEncoder, x: number, y: number, width: number, height: number, minDepth: number, maxDepth: number) {\n    const {\n      targetWidth,\n      targetHeight,\n    } = renderPassToPassInfoMap.get(this)!;\n    assert(x >= 0, 'x < 0');\n    assert(y >= 0, 'y < 0');\n    assert(x + width <= targetWidth, 'x + width > texture.width');\n    assert(y + height <= targetHeight, 'y + height > texture.height');\n  });\n\n}"],"names":[],"mappings":"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"}